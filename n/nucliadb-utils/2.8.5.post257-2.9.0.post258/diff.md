# Comparing `tmp/nucliadb_utils-2.8.5.post257-py3-none-any.whl.zip` & `tmp/nucliadb_utils-2.9.0.post258-py3-none-any.whl.zip`

## zipinfo {}

```diff
@@ -1,71 +1,71 @@
-Zip file size: 100654 bytes, number of entries: 69
--rw-r--r--  2.0 unx      895 b- defN 23-May-11 12:09 nucliadb_utils/__init__.py
--rw-r--r--  2.0 unx     5877 b- defN 23-May-11 12:09 nucliadb_utils/authentication.py
--rw-r--r--  2.0 unx     4518 b- defN 23-May-11 12:09 nucliadb_utils/clandestined.py
--rw-r--r--  2.0 unx     1737 b- defN 23-May-11 12:09 nucliadb_utils/const.py
--rw-r--r--  2.0 unx     1138 b- defN 23-May-11 12:09 nucliadb_utils/exceptions.py
--rw-r--r--  2.0 unx     2145 b- defN 23-May-11 12:09 nucliadb_utils/featureflagging.py
--rw-r--r--  2.0 unx     2212 b- defN 23-May-11 12:09 nucliadb_utils/grpc.py
--rw-r--r--  2.0 unx     3474 b- defN 23-May-11 12:09 nucliadb_utils/indexing.py
--rw-r--r--  2.0 unx      867 b- defN 23-May-11 12:09 nucliadb_utils/keys.py
--rw-r--r--  2.0 unx     5993 b- defN 23-May-11 12:09 nucliadb_utils/nats.py
--rw-r--r--  2.0 unx     1173 b- defN 23-May-11 12:09 nucliadb_utils/partition.py
--rw-r--r--  2.0 unx        0 b- defN 23-May-11 12:09 nucliadb_utils/py.typed
--rw-r--r--  2.0 unx     1713 b- defN 23-May-11 12:09 nucliadb_utils/run.py
--rw-r--r--  2.0 unx     4687 b- defN 23-May-11 12:09 nucliadb_utils/settings.py
--rw-r--r--  2.0 unx      890 b- defN 23-May-11 12:09 nucliadb_utils/store.py
--rw-r--r--  2.0 unx     6621 b- defN 23-May-11 12:09 nucliadb_utils/transaction.py
--rw-r--r--  2.0 unx    13338 b- defN 23-May-11 12:09 nucliadb_utils/utilities.py
--rw-r--r--  2.0 unx      835 b- defN 23-May-11 12:09 nucliadb_utils/audit/__init__.py
--rw-r--r--  2.0 unx     2013 b- defN 23-May-11 12:09 nucliadb_utils/audit/audit.py
--rw-r--r--  2.0 unx     2446 b- defN 23-May-11 12:09 nucliadb_utils/audit/basic.py
--rw-r--r--  2.0 unx     7688 b- defN 23-May-11 12:09 nucliadb_utils/audit/stream.py
--rw-r--r--  2.0 unx      900 b- defN 23-May-11 12:09 nucliadb_utils/cache/__init__.py
--rw-r--r--  2.0 unx      975 b- defN 23-May-11 12:09 nucliadb_utils/cache/exceptions.py
--rw-r--r--  2.0 unx     1216 b- defN 23-May-11 12:09 nucliadb_utils/cache/memcache.py
--rw-r--r--  2.0 unx     7089 b- defN 23-May-11 12:09 nucliadb_utils/cache/nats.py
--rw-r--r--  2.0 unx     1654 b- defN 23-May-11 12:09 nucliadb_utils/cache/pubsub.py
--rw-r--r--  2.0 unx     3110 b- defN 23-May-11 12:09 nucliadb_utils/cache/redis.py
--rw-r--r--  2.0 unx     1302 b- defN 23-May-11 12:09 nucliadb_utils/cache/settings.py
--rw-r--r--  2.0 unx     5906 b- defN 23-May-11 12:09 nucliadb_utils/cache/utility.py
--rw-r--r--  2.0 unx      833 b- defN 23-May-11 12:09 nucliadb_utils/fastapi/__init__.py
--rw-r--r--  2.0 unx     1737 b- defN 23-May-11 12:09 nucliadb_utils/fastapi/openapi.py
--rw-r--r--  2.0 unx     3631 b- defN 23-May-11 12:09 nucliadb_utils/fastapi/run.py
--rw-r--r--  2.0 unx     3786 b- defN 23-May-11 12:09 nucliadb_utils/fastapi/versioning.py
--rw-r--r--  2.0 unx      855 b- defN 23-May-11 12:09 nucliadb_utils/storages/__init__.py
--rw-r--r--  2.0 unx     2274 b- defN 23-May-11 12:09 nucliadb_utils/storages/exceptions.py
--rw-r--r--  2.0 unx    24880 b- defN 23-May-11 12:09 nucliadb_utils/storages/gcs.py
--rw-r--r--  2.0 unx    10180 b- defN 23-May-11 12:09 nucliadb_utils/storages/local.py
--rw-r--r--  2.0 unx     2093 b- defN 23-May-11 12:09 nucliadb_utils/storages/nuclia.py
--rw-r--r--  2.0 unx    17174 b- defN 23-May-11 12:09 nucliadb_utils/storages/pg.py
--rw-r--r--  2.0 unx    15029 b- defN 23-May-11 12:09 nucliadb_utils/storages/s3.py
--rw-r--r--  2.0 unx     1276 b- defN 23-May-11 12:09 nucliadb_utils/storages/settings.py
--rw-r--r--  2.0 unx    17691 b- defN 23-May-11 12:09 nucliadb_utils/storages/storage.py
--rw-r--r--  2.0 unx      994 b- defN 23-May-11 12:09 nucliadb_utils/tests/__init__.py
--rw-r--r--  2.0 unx    10691 b- defN 23-May-11 12:09 nucliadb_utils/tests/asyncbenchmark.py
--rw-r--r--  2.0 unx     1043 b- defN 23-May-11 12:09 nucliadb_utils/tests/clandestined.py
--rw-r--r--  2.0 unx     1686 b- defN 23-May-11 12:09 nucliadb_utils/tests/conftest.py
--rw-r--r--  2.0 unx     2758 b- defN 23-May-11 12:09 nucliadb_utils/tests/gcs.py
--rw-r--r--  2.0 unx     1513 b- defN 23-May-11 12:09 nucliadb_utils/tests/indexing.py
--rw-r--r--  2.0 unx     1310 b- defN 23-May-11 12:09 nucliadb_utils/tests/local.py
--rw-r--r--  2.0 unx     7699 b- defN 23-May-11 12:09 nucliadb_utils/tests/nats.py
--rw-r--r--  2.0 unx     2216 b- defN 23-May-11 12:09 nucliadb_utils/tests/s3.py
--rw-r--r--  2.0 unx      833 b- defN 23-May-11 12:09 nucliadb_utils/tests/unit/__init__.py
--rw-r--r--  2.0 unx     5159 b- defN 23-May-11 12:09 nucliadb_utils/tests/unit/test_authentication.py
--rw-r--r--  2.0 unx    14507 b- defN 23-May-11 12:09 nucliadb_utils/tests/unit/test_clandestined.py
--rw-r--r--  2.0 unx     1949 b- defN 23-May-11 12:09 nucliadb_utils/tests/unit/test_clandestined_collision.py
--rw-r--r--  2.0 unx     5303 b- defN 23-May-11 12:09 nucliadb_utils/tests/unit/test_clandestined_rendezvous_hash.py
--rw-r--r--  2.0 unx     3083 b- defN 23-May-11 12:09 nucliadb_utils/tests/unit/test_nats.py
--rw-r--r--  2.0 unx     1910 b- defN 23-May-11 12:09 nucliadb_utils/tests/unit/test_run.py
--rw-r--r--  2.0 unx     1189 b- defN 23-May-11 12:09 nucliadb_utils/tests/unit/test_tests.py
--rw-r--r--  2.0 unx     3408 b- defN 23-May-11 12:09 nucliadb_utils/tests/unit/test_transaction.py
--rw-r--r--  2.0 unx     5277 b- defN 23-May-11 12:09 nucliadb_utils/tests/unit/test_utilities.py
--rw-r--r--  2.0 unx      833 b- defN 23-May-11 12:09 nucliadb_utils/tests/unit/storages/__init__.py
--rw-r--r--  2.0 unx    16726 b- defN 23-May-11 12:09 nucliadb_utils/tests/unit/storages/test_pg.py
--rw-r--r--  2.0 unx     5638 b- defN 23-May-11 12:09 nucliadb_utils/tests/unit/storages/test_storage.py
--rw-r--r--  2.0 unx     1816 b- defN 23-May-11 12:11 nucliadb_utils-2.8.5.post257.dist-info/METADATA
--rw-r--r--  2.0 unx       92 b- defN 23-May-11 12:11 nucliadb_utils-2.8.5.post257.dist-info/WHEEL
--rw-r--r--  2.0 unx       15 b- defN 23-May-11 12:11 nucliadb_utils-2.8.5.post257.dist-info/top_level.txt
--rw-r--r--  2.0 unx        1 b- defN 23-May-11 12:10 nucliadb_utils-2.8.5.post257.dist-info/zip-safe
--rw-rw-r--  2.0 unx     6208 b- defN 23-May-11 12:11 nucliadb_utils-2.8.5.post257.dist-info/RECORD
-69 files, 297708 bytes uncompressed, 90706 bytes compressed:  69.5%
+Zip file size: 101087 bytes, number of entries: 69
+-rw-r--r--  2.0 unx      895 b- defN 23-May-11 16:46 nucliadb_utils/__init__.py
+-rw-r--r--  2.0 unx     5877 b- defN 23-May-11 16:46 nucliadb_utils/authentication.py
+-rw-r--r--  2.0 unx     4518 b- defN 23-May-11 16:46 nucliadb_utils/clandestined.py
+-rw-r--r--  2.0 unx     1879 b- defN 23-May-11 16:46 nucliadb_utils/const.py
+-rw-r--r--  2.0 unx     1138 b- defN 23-May-11 16:46 nucliadb_utils/exceptions.py
+-rw-r--r--  2.0 unx     2276 b- defN 23-May-11 16:46 nucliadb_utils/featureflagging.py
+-rw-r--r--  2.0 unx     2212 b- defN 23-May-11 16:46 nucliadb_utils/grpc.py
+-rw-r--r--  2.0 unx     3474 b- defN 23-May-11 16:46 nucliadb_utils/indexing.py
+-rw-r--r--  2.0 unx      867 b- defN 23-May-11 16:46 nucliadb_utils/keys.py
+-rw-r--r--  2.0 unx     6093 b- defN 23-May-11 16:46 nucliadb_utils/nats.py
+-rw-r--r--  2.0 unx     1173 b- defN 23-May-11 16:46 nucliadb_utils/partition.py
+-rw-r--r--  2.0 unx        0 b- defN 23-May-11 16:46 nucliadb_utils/py.typed
+-rw-r--r--  2.0 unx     1713 b- defN 23-May-11 16:46 nucliadb_utils/run.py
+-rw-r--r--  2.0 unx     4687 b- defN 23-May-11 16:46 nucliadb_utils/settings.py
+-rw-r--r--  2.0 unx      890 b- defN 23-May-11 16:46 nucliadb_utils/store.py
+-rw-r--r--  2.0 unx     6621 b- defN 23-May-11 16:46 nucliadb_utils/transaction.py
+-rw-r--r--  2.0 unx    13338 b- defN 23-May-11 16:46 nucliadb_utils/utilities.py
+-rw-r--r--  2.0 unx      835 b- defN 23-May-11 16:46 nucliadb_utils/audit/__init__.py
+-rw-r--r--  2.0 unx     2419 b- defN 23-May-11 16:46 nucliadb_utils/audit/audit.py
+-rw-r--r--  2.0 unx     2951 b- defN 23-May-11 16:46 nucliadb_utils/audit/basic.py
+-rw-r--r--  2.0 unx     8134 b- defN 23-May-11 16:46 nucliadb_utils/audit/stream.py
+-rw-r--r--  2.0 unx      900 b- defN 23-May-11 16:46 nucliadb_utils/cache/__init__.py
+-rw-r--r--  2.0 unx      975 b- defN 23-May-11 16:46 nucliadb_utils/cache/exceptions.py
+-rw-r--r--  2.0 unx     1216 b- defN 23-May-11 16:46 nucliadb_utils/cache/memcache.py
+-rw-r--r--  2.0 unx     7089 b- defN 23-May-11 16:46 nucliadb_utils/cache/nats.py
+-rw-r--r--  2.0 unx     1654 b- defN 23-May-11 16:46 nucliadb_utils/cache/pubsub.py
+-rw-r--r--  2.0 unx     3136 b- defN 23-May-11 16:46 nucliadb_utils/cache/redis.py
+-rw-r--r--  2.0 unx     1302 b- defN 23-May-11 16:46 nucliadb_utils/cache/settings.py
+-rw-r--r--  2.0 unx     5906 b- defN 23-May-11 16:46 nucliadb_utils/cache/utility.py
+-rw-r--r--  2.0 unx      833 b- defN 23-May-11 16:46 nucliadb_utils/fastapi/__init__.py
+-rw-r--r--  2.0 unx     1737 b- defN 23-May-11 16:46 nucliadb_utils/fastapi/openapi.py
+-rw-r--r--  2.0 unx     3631 b- defN 23-May-11 16:46 nucliadb_utils/fastapi/run.py
+-rw-r--r--  2.0 unx     3786 b- defN 23-May-11 16:46 nucliadb_utils/fastapi/versioning.py
+-rw-r--r--  2.0 unx      855 b- defN 23-May-11 16:46 nucliadb_utils/storages/__init__.py
+-rw-r--r--  2.0 unx     2274 b- defN 23-May-11 16:46 nucliadb_utils/storages/exceptions.py
+-rw-r--r--  2.0 unx    24880 b- defN 23-May-11 16:46 nucliadb_utils/storages/gcs.py
+-rw-r--r--  2.0 unx    10180 b- defN 23-May-11 16:46 nucliadb_utils/storages/local.py
+-rw-r--r--  2.0 unx     2093 b- defN 23-May-11 16:46 nucliadb_utils/storages/nuclia.py
+-rw-r--r--  2.0 unx    17174 b- defN 23-May-11 16:46 nucliadb_utils/storages/pg.py
+-rw-r--r--  2.0 unx    15029 b- defN 23-May-11 16:46 nucliadb_utils/storages/s3.py
+-rw-r--r--  2.0 unx     1276 b- defN 23-May-11 16:46 nucliadb_utils/storages/settings.py
+-rw-r--r--  2.0 unx    17691 b- defN 23-May-11 16:46 nucliadb_utils/storages/storage.py
+-rw-r--r--  2.0 unx      994 b- defN 23-May-11 16:46 nucliadb_utils/tests/__init__.py
+-rw-r--r--  2.0 unx    10691 b- defN 23-May-11 16:46 nucliadb_utils/tests/asyncbenchmark.py
+-rw-r--r--  2.0 unx     1043 b- defN 23-May-11 16:46 nucliadb_utils/tests/clandestined.py
+-rw-r--r--  2.0 unx     1686 b- defN 23-May-11 16:46 nucliadb_utils/tests/conftest.py
+-rw-r--r--  2.0 unx     2758 b- defN 23-May-11 16:46 nucliadb_utils/tests/gcs.py
+-rw-r--r--  2.0 unx     1513 b- defN 23-May-11 16:46 nucliadb_utils/tests/indexing.py
+-rw-r--r--  2.0 unx     1310 b- defN 23-May-11 16:46 nucliadb_utils/tests/local.py
+-rw-r--r--  2.0 unx     7699 b- defN 23-May-11 16:46 nucliadb_utils/tests/nats.py
+-rw-r--r--  2.0 unx     2216 b- defN 23-May-11 16:46 nucliadb_utils/tests/s3.py
+-rw-r--r--  2.0 unx      833 b- defN 23-May-11 16:46 nucliadb_utils/tests/unit/__init__.py
+-rw-r--r--  2.0 unx     5159 b- defN 23-May-11 16:46 nucliadb_utils/tests/unit/test_authentication.py
+-rw-r--r--  2.0 unx    14507 b- defN 23-May-11 16:46 nucliadb_utils/tests/unit/test_clandestined.py
+-rw-r--r--  2.0 unx     1949 b- defN 23-May-11 16:46 nucliadb_utils/tests/unit/test_clandestined_collision.py
+-rw-r--r--  2.0 unx     5303 b- defN 23-May-11 16:46 nucliadb_utils/tests/unit/test_clandestined_rendezvous_hash.py
+-rw-r--r--  2.0 unx     3083 b- defN 23-May-11 16:46 nucliadb_utils/tests/unit/test_nats.py
+-rw-r--r--  2.0 unx     1910 b- defN 23-May-11 16:46 nucliadb_utils/tests/unit/test_run.py
+-rw-r--r--  2.0 unx     1189 b- defN 23-May-11 16:46 nucliadb_utils/tests/unit/test_tests.py
+-rw-r--r--  2.0 unx     3408 b- defN 23-May-11 16:46 nucliadb_utils/tests/unit/test_transaction.py
+-rw-r--r--  2.0 unx     5277 b- defN 23-May-11 16:46 nucliadb_utils/tests/unit/test_utilities.py
+-rw-r--r--  2.0 unx      833 b- defN 23-May-11 16:46 nucliadb_utils/tests/unit/storages/__init__.py
+-rw-r--r--  2.0 unx    16726 b- defN 23-May-11 16:46 nucliadb_utils/tests/unit/storages/test_pg.py
+-rw-r--r--  2.0 unx     5638 b- defN 23-May-11 16:46 nucliadb_utils/tests/unit/storages/test_storage.py
+-rw-r--r--  2.0 unx     1816 b- defN 23-May-11 16:48 nucliadb_utils-2.9.0.post258.dist-info/METADATA
+-rw-r--r--  2.0 unx       92 b- defN 23-May-11 16:48 nucliadb_utils-2.9.0.post258.dist-info/WHEEL
+-rw-r--r--  2.0 unx       15 b- defN 23-May-11 16:48 nucliadb_utils-2.9.0.post258.dist-info/top_level.txt
+-rw-r--r--  2.0 unx        1 b- defN 23-May-11 16:47 nucliadb_utils-2.9.0.post258.dist-info/zip-safe
+-rw-rw-r--  2.0 unx     6208 b- defN 23-May-11 16:48 nucliadb_utils-2.9.0.post258.dist-info/RECORD
+69 files, 299464 bytes uncompressed, 91139 bytes compressed:  69.6%
```

## zipnote {}

```diff
@@ -186,23 +186,23 @@
 
 Filename: nucliadb_utils/tests/unit/storages/test_pg.py
 Comment: 
 
 Filename: nucliadb_utils/tests/unit/storages/test_storage.py
 Comment: 
 
-Filename: nucliadb_utils-2.8.5.post257.dist-info/METADATA
+Filename: nucliadb_utils-2.9.0.post258.dist-info/METADATA
 Comment: 
 
-Filename: nucliadb_utils-2.8.5.post257.dist-info/WHEEL
+Filename: nucliadb_utils-2.9.0.post258.dist-info/WHEEL
 Comment: 
 
-Filename: nucliadb_utils-2.8.5.post257.dist-info/top_level.txt
+Filename: nucliadb_utils-2.9.0.post258.dist-info/top_level.txt
 Comment: 
 
-Filename: nucliadb_utils-2.8.5.post257.dist-info/zip-safe
+Filename: nucliadb_utils-2.9.0.post258.dist-info/zip-safe
 Comment: 
 
-Filename: nucliadb_utils-2.8.5.post257.dist-info/RECORD
+Filename: nucliadb_utils-2.9.0.post258.dist-info/RECORD
 Comment: 
 
 Zip file comment:
```

## nucliadb_utils/const.py

```diff
@@ -14,14 +14,15 @@
 # MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 # GNU Affero General Public License for more details.
 #
 # You should have received a copy of the GNU Affero General Public License
 # along with this program. If not, see <http://www.gnu.org/licenses/>.
 #
 class PubSubChannels:
+    # stream that ingest/node publishes to for information
     RESOURCE_NOTIFY = "notify.{kbid}"
 
 
 class Streams:
     class INGEST:
         """
         Writing resource changes go to this steam/consumer group.
@@ -50,7 +51,8 @@
         subject = "node.{node}"
         group = "node-{node}"
 
 
 class Features:
     WAIT_FOR_INDEX = "nucliadb_wait_for_resource_index"
     SEPARATE_PROCESSED_MESSAGE_WRITES = "nucliadb_separate_processed_message_writes"
+    AUDITING_BW_COMPAT_SHARD_COUNTER = "nucliadb_auditing_bw_compat_shard_counter"
```

## nucliadb_utils/featureflagging.py

```diff
@@ -39,14 +39,18 @@
         "rollout": 0,
         "variants": {"environment": ["none"]},
     },
     const.Features.SEPARATE_PROCESSED_MESSAGE_WRITES: {
         "rollout": 0,
         "variants": {"environment": ["none"]},
     },
+    const.Features.AUDITING_BW_COMPAT_SHARD_COUNTER: {
+        "rollout": 0,
+        "variants": {"environment": ["none"]},
+    },
 }
 
 
 class FlagService:
     def __init__(self):
         self.settings = Settings()
         if self.settings.flag_settings_url is None:
```

## nucliadb_utils/nats.py

```diff
@@ -104,16 +104,19 @@
         async with self._lock:
             for sub, _ in self._subscriptions:
                 try:
                     await sub.drain()
                 except nats.errors.ConnectionClosedError:  # pragma: no cover
                     pass
             try:
-                await self.nc.drain()
-            except nats.errors.ConnectionClosedError:  # pragma: no cover
+                await asyncio.wait_for(self.nc.drain(), timeout=1)
+            except (
+                nats.errors.ConnectionClosedError,
+                asyncio.TimeoutError,
+            ):  # pragma: no cover
                 pass
             await self.nc.close()
             self._subscriptions = []
 
     async def disconnected_cb(self) -> None:
         logger.info("Disconnected from NATS!")
         self._last_unhealthy = time.monotonic()
```

## nucliadb_utils/audit/audit.py

```diff
@@ -13,24 +13,42 @@
 # but WITHOUT ANY WARRANTY; without even the implied warranty of
 # MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 # GNU Affero General Public License for more details.
 #
 # You should have received a copy of the GNU Affero General Public License
 # along with this program. If not, see <http://www.gnu.org/licenses/>.
 #
-
 from typing import List, Optional
 
-from nucliadb_protos.audit_pb2 import AuditField, AuditRequest, AuditShardCounter
+from google.protobuf.timestamp_pb2 import Timestamp
+from nucliadb_protos.audit_pb2 import (
+    AuditField,
+    AuditKBCounter,
+    AuditRequest,
+    AuditShardCounter,
+)
 from nucliadb_protos.nodereader_pb2 import SearchRequest
-from nucliadb_protos.writer_pb2 import BrokerMessage
+from nucliadb_protos.resources_pb2 import FieldID
 
 
 class AuditStorage:
-    async def report(self, message: BrokerMessage, audit_type: AuditRequest.AuditType.Value, audit_fields: Optional[List[AuditField]] = None, counter: Optional[AuditShardCounter] = None):  # type: ignore
+    async def report(
+        self,
+        *,
+        kbid: str,
+        audit_type: AuditRequest.AuditType.Value,  # type: ignore
+        when: Optional[Timestamp] = None,
+        user: Optional[str] = None,
+        origin: Optional[str] = None,
+        rid: Optional[str] = None,
+        field_metadata: Optional[List[FieldID]] = None,
+        audit_fields: Optional[List[AuditField]] = None,
+        counter: Optional[AuditShardCounter] = None,
+        kb_counter: Optional[AuditKBCounter] = None,
+    ):  # type: ignore
         raise NotImplementedError
 
     async def initialize(self):
         pass
 
     async def finalize(self):
         pass
```

## nucliadb_utils/audit/basic.py

```diff
@@ -15,28 +15,50 @@
 # GNU Affero General Public License for more details.
 #
 # You should have received a copy of the GNU Affero General Public License
 # along with this program. If not, see <http://www.gnu.org/licenses/>.
 #
 from typing import List, Optional
 
-from nucliadb_protos.audit_pb2 import AuditField, AuditRequest, AuditShardCounter
+from google.protobuf.timestamp_pb2 import Timestamp
+from nucliadb_protos.audit_pb2 import (
+    AuditField,
+    AuditKBCounter,
+    AuditRequest,
+    AuditShardCounter,
+)
 from nucliadb_protos.nodereader_pb2 import SearchRequest
+from nucliadb_protos.resources_pb2 import FieldID
 from nucliadb_protos.writer_pb2 import BrokerMessage
 
 from nucliadb_utils import logger
 from nucliadb_utils.audit.audit import AuditStorage
 
 
 class BasicAuditStorage(AuditStorage):
     def message_to_str(self, message: BrokerMessage) -> str:
         return f"{message.type}+{message.multiid}+{message.audit.user}+{message.kbid}+{message.uuid}+{message.audit.when.ToJsonString()}+{message.audit.origin}+{message.audit.source}"  # noqa
 
-    async def report(self, message: BrokerMessage, audit_type: AuditRequest.AuditType.Value, audit_fields: Optional[List[AuditField]] = None, counter: Optional[AuditShardCounter] = None):  # type: ignore
-        logger.debug(f"AUDIT {audit_type} {self.message_to_str(message)}")
+    async def report(
+        self,
+        *,
+        kbid: str,
+        audit_type: AuditRequest.AuditType.Value,  # type: ignore
+        when: Optional[Timestamp] = None,
+        user: Optional[str] = None,
+        origin: Optional[str] = None,
+        rid: Optional[str] = None,
+        field_metadata: Optional[List[FieldID]] = None,
+        audit_fields: Optional[List[AuditField]] = None,
+        counter: Optional[AuditShardCounter] = None,
+        kb_counter: Optional[AuditKBCounter] = None,
+    ):  # type: ignore
+        logger.debug(
+            f"AUDIT {audit_type} {kbid} {user} {origin} {rid} {audit_fields} {counter}"
+        )
 
     async def visited(self, kbid: str, uuid: str, user: str, origin: str):
         logger.debug(f"VISITED {kbid} {uuid} {user} {origin}")
 
     async def search(
         self,
         kbid: str,
```

## nucliadb_utils/audit/stream.py

```diff
@@ -19,17 +19,23 @@
 #
 import asyncio
 from datetime import datetime
 from typing import List, Optional
 
 import mmh3  # type: ignore
 import nats
-from nucliadb_protos.audit_pb2 import AuditField, AuditRequest, AuditShardCounter
+from google.protobuf.timestamp_pb2 import Timestamp
+from nucliadb_protos.audit_pb2 import (
+    AuditField,
+    AuditKBCounter,
+    AuditRequest,
+    AuditShardCounter,
+)
 from nucliadb_protos.nodereader_pb2 import SearchRequest
-from nucliadb_protos.writer_pb2 import BrokerMessage
+from nucliadb_protos.resources_pb2 import FieldID
 from opentelemetry.trace import get_current_span
 
 from nucliadb_utils import logger
 from nucliadb_utils.audit.audit import AuditStorage
 from nucliadb_utils.nats import get_traced_jetstream
 
 
@@ -128,34 +134,46 @@
         logger.debug(
             f"Pushed message to audit.  kb: {message.kbid}, resource: {message.rid}, partition: {partition}"
         )
         return res.seq
 
     async def report(
         self,
-        message: BrokerMessage,
+        *,
+        kbid: str,
         audit_type: AuditRequest.AuditType.Value,  # type: ignore
+        when: Optional[Timestamp] = None,
+        user: Optional[str] = None,
+        origin: Optional[str] = None,
+        rid: Optional[str] = None,
+        field_metadata: Optional[List[FieldID]] = None,
         audit_fields: Optional[List[AuditField]] = None,
         counter: Optional[AuditShardCounter] = None,
+        kb_counter: Optional[AuditKBCounter] = None,
     ):
         # Reports MODIFIED / DELETED / NEW events
         auditrequest = AuditRequest()
-        auditrequest.kbid = message.kbid
-        auditrequest.userid = message.audit.user
-        auditrequest.rid = message.uuid
-        auditrequest.origin = message.audit.origin
+        auditrequest.kbid = kbid
+        auditrequest.userid = user or ""
+        auditrequest.rid = rid or ""
+        auditrequest.origin = origin or ""
         auditrequest.type = audit_type
-        auditrequest.time.CopyFrom(message.audit.when)
+        if when is None:
+            auditrequest.time.FromDatetime(datetime.now())
+        else:
+            auditrequest.time.CopyFrom(when)
 
-        for field in message.field_metadata:
-            auditrequest.field_metadata.append(field.field)
+        auditrequest.field_metadata.extend(field_metadata or [])
 
         if audit_fields:
             auditrequest.fields_audit.extend(audit_fields)
 
+        if kb_counter:
+            auditrequest.kb_counter.CopyFrom(kb_counter)
+
         if counter:
             auditrequest.counter.CopyFrom(counter)
 
         auditrequest.trace_id = str(get_current_span().get_span_context().trace_id)
 
         await self.send(auditrequest)
```

## nucliadb_utils/cache/redis.py

```diff
@@ -49,15 +49,15 @@
             self.initialized = True
 
     async def finalize(self):
         await self.pubsub.unsubscribe()
         if self.task:
             self.task.cancel()
         if self.driver:
-            await self.driver.close()
+            await self.driver.close(close_connection_pool=True)
         self.initialized = False
 
     async def publish(self, key: str, value: bytes):
         if self.driver is None:
             raise NoPubsubConfigured()
 
         with redis_observer(labels={"type": "publish"}):
```

## Comparing `nucliadb_utils-2.8.5.post257.dist-info/METADATA` & `nucliadb_utils-2.9.0.post258.dist-info/METADATA`

 * *Files 6% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: nucliadb-utils
-Version: 2.8.5.post257
+Version: 2.9.0.post258
 Summary: UNKNOWN
 Home-page: https://nuclia.com
 License: BSD
 Platform: UNKNOWN
 Classifier: Development Status :: 4 - Beta
 Classifier: Programming Language :: Python :: 3.7
 Classifier: Topic :: Software Development :: Libraries :: Python Modules
@@ -12,15 +12,15 @@
 Requires-Dist: aiohttp (>=3.8.1)
 Requires-Dist: prometheus-client (>=0.12.0)
 Requires-Dist: types-requests (>=2.27.7)
 Requires-Dist: mmh3 (>=3.0.0)
 Requires-Dist: nats-py[nkeys] (==2.1.3)
 Requires-Dist: pyjwt (>=2.4.0)
 Requires-Dist: memorylru (>=1.1.2)
-Requires-Dist: nucliadb-protos (==2.8.5-post257)
+Requires-Dist: nucliadb-protos (==2.9.0-post258)
 Requires-Dist: nucliadb-telemetry (>=1.9.2)
 Requires-Dist: mrflagly
 Requires-Dist: urllib3 (<1.27,>=1.21.1)
 Provides-Extra: cache
 Requires-Dist: redis (>=4.3.4) ; extra == 'cache'
 Requires-Dist: orjson (>=3.6.7) ; extra == 'cache'
 Requires-Dist: lru-dict (>=1.1.7) ; extra == 'cache'
```

## Comparing `nucliadb_utils-2.8.5.post257.dist-info/RECORD` & `nucliadb_utils-2.9.0.post258.dist-info/RECORD`

 * *Files 4% similar despite different names*

```diff
@@ -1,34 +1,34 @@
 nucliadb_utils/__init__.py,sha256=EvBCH1iTODe-AgXm48aj4kVUt_Std3PeL8QnwimR5wI,895
 nucliadb_utils/authentication.py,sha256=Ww3aTu1SrU0KvHZDSr14Ys_iplQXgAgA_GsdRDp51lY,5877
 nucliadb_utils/clandestined.py,sha256=impMwO7eLA-peRuY4nPqMtMLHWU1nZQC040SHC22XJg,4518
-nucliadb_utils/const.py,sha256=G7ASK7kXgZzo6JpbCGV94pr1TOVgR-e4lh79RVzaYBs,1737
+nucliadb_utils/const.py,sha256=0tidQuJX8WIm3MJnkPHhRWzi2swpSl7jdp9Y4kd8N_k,1879
 nucliadb_utils/exceptions.py,sha256=o6UkFIq1jV1p7n3j73L4MyrGs9j3SJ2Fa-1hOH1KGhY,1138
-nucliadb_utils/featureflagging.py,sha256=NVCK-akNZB_ZAXbTwc348PJruQ1fON8ymDd9RQpPyDs,2145
+nucliadb_utils/featureflagging.py,sha256=L16lrNGzjXfOQl5aXOR0XUHIcbbapihUEb35OUhZxnY,2276
 nucliadb_utils/grpc.py,sha256=DJE9tQDvjUiiyF43F3Bsl5tfXmjO49l89IETfBOgCIo,2212
 nucliadb_utils/indexing.py,sha256=ceaHDDYCBrHXEVxgitRBY1--r5_XXl1Wzq4MvAsQWI0,3474
 nucliadb_utils/keys.py,sha256=fjumJHFoRaTbasLO5jZJ46xacAy-HqYAN-8Oquup75o,867
-nucliadb_utils/nats.py,sha256=Cf9_6FvgYq_201m_X7TvjVI3j50iY01RDSENaGVCkP4,5993
+nucliadb_utils/nats.py,sha256=gbSZBm7kXy9-u3nbnb9msQVCVhGimoM7W5VN-5S0r0g,6093
 nucliadb_utils/partition.py,sha256=0tmXuwRM_v-OmKoRkB--OMDzomVEkmgxqMmNNomI_24,1173
 nucliadb_utils/py.typed,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
 nucliadb_utils/run.py,sha256=bKMfsPEK6WdWfiPyWPUxCqcLo4tq6eOwyaf910TOwBk,1713
 nucliadb_utils/settings.py,sha256=fqygIHZxO4WDlJ_L1mNZFH97jBgOD45tQYG2GuG10vY,4687
 nucliadb_utils/store.py,sha256=kQ35HemE0v4_Qg6xVqNIJi8vSFAYQtwI3rDtMsNy62Y,890
 nucliadb_utils/transaction.py,sha256=Zr5E02Y9lurbWOVRJi-gzTfvIl_0sxp8fsSuNX4cYsM,6621
 nucliadb_utils/utilities.py,sha256=TyWzs-8Epw44cPEWeXnHYHEKy7_1jH7UUPDVLEamWCg,13338
 nucliadb_utils/audit/__init__.py,sha256=cp15ZcFnHvpcu_5-aK2A4uUyvuZVV_MJn4bIXMa20ks,835
-nucliadb_utils/audit/audit.py,sha256=eZwbTaDHtEAqjtJ34eNuBtv05tK6XfcfcxWeGgOl4Z4,2013
-nucliadb_utils/audit/basic.py,sha256=V6bYvJqP9cvagrvnrYaym0aKpictP0XvL_s34S0YX68,2446
-nucliadb_utils/audit/stream.py,sha256=jZe2VbZ4dR5oRkfOnoOKsmEeQMqcUWMxsjccL7oJCW8,7688
+nucliadb_utils/audit/audit.py,sha256=cFDLmMVMkJVz6nsOQzYEebePgTTc-X-SruWnOgiMFTA,2419
+nucliadb_utils/audit/basic.py,sha256=mAfrGLZW9caFWj_3wmToz62sQ9EkgLdNOnhMD58Totg,2951
+nucliadb_utils/audit/stream.py,sha256=B9iSqlvgsWdsAFTM6s7mv43sCEdN_qIUG3f2WovT46M,8134
 nucliadb_utils/cache/__init__.py,sha256=vVp-ZPp_aGpofI754T7E9JxsMkATqAEytangiKvE1Nk,900
 nucliadb_utils/cache/exceptions.py,sha256=Zu-O_-0-yctOEgoDGI92gPzWfBMRrpiAyESA62ld6MA,975
 nucliadb_utils/cache/memcache.py,sha256=CWd09BLh0K7vmxmj3Bhh0cLlCVeI_uvkzubqJpK7h0A,1216
 nucliadb_utils/cache/nats.py,sha256=h0x894QNLkkvyOcmqH8ncC-d0AiHm9SjDgvPPiwxYao,7089
 nucliadb_utils/cache/pubsub.py,sha256=l8i_RwRf7OPzfmPy-gyn66xgYFs5aHidCIjEaU9VOHE,1654
-nucliadb_utils/cache/redis.py,sha256=EvtfbZgBDwDMgZNeHCsfJylFWlHFTp8NdC3zQHzHfEc,3110
+nucliadb_utils/cache/redis.py,sha256=mNlXRQ-b9m75JemwAvrUG_DqFAvUe64EOyLyL8BjW5o,3136
 nucliadb_utils/cache/settings.py,sha256=CP4YsCYQUFC3ki_i-54qoMZX-Iup53nrT1V9NIg05RE,1302
 nucliadb_utils/cache/utility.py,sha256=N_3BjomLEEmoZ3ieGWsRZXuwrhLK-qqH8mF0UsldjF0,5906
 nucliadb_utils/fastapi/__init__.py,sha256=itSI7dtTwFP55YMX4iK7JzdMHS5CQVUiB1XzQu4UBh8,833
 nucliadb_utils/fastapi/openapi.py,sha256=b0pLuri0QuzQd0elDyOVXM42YYmES_cmT-jEfsQ1G6Y,1737
 nucliadb_utils/fastapi/run.py,sha256=5GgD3JutN5gIt7-V76mB8nT9kSPx7cNBz5U4PAu2fkI,3631
 nucliadb_utils/fastapi/versioning.py,sha256=yzHG_TS8ga-qXum6op2dZUxDrVr_zBjAu6LNz28Elao,3786
 nucliadb_utils/storages/__init__.py,sha256=WOSaQhFBQ_TePebZa1nCy_MJAI61ioY_52P9x8LG4SI,855
@@ -58,12 +58,12 @@
 nucliadb_utils/tests/unit/test_run.py,sha256=VHeojVBj_AfV_uNch9eEi4zCT-O94VKjwb_O-UZgqpA,1910
 nucliadb_utils/tests/unit/test_tests.py,sha256=-YHgVMKJr_3WYwrBj9TnwpVLIkP80PLZpWnvAIYvnz8,1189
 nucliadb_utils/tests/unit/test_transaction.py,sha256=la8d5ZyCOyWflPJ11Uz3OEFCJ7ARWF9YWrxToLKdjkI,3408
 nucliadb_utils/tests/unit/test_utilities.py,sha256=LO7QVMmx-jpeySJq7kLdyIR-G8fEYAAwHbQ8nioTvGI,5277
 nucliadb_utils/tests/unit/storages/__init__.py,sha256=itSI7dtTwFP55YMX4iK7JzdMHS5CQVUiB1XzQu4UBh8,833
 nucliadb_utils/tests/unit/storages/test_pg.py,sha256=KAIzD3QuJFMRNSSAKz-M5qrO9fJIHYbZfiOOleTgP1c,16726
 nucliadb_utils/tests/unit/storages/test_storage.py,sha256=kgZFXc-y_BX3HlcNHERzAkNPhNilXXQawIHBFq_5Q1k,5638
-nucliadb_utils-2.8.5.post257.dist-info/METADATA,sha256=t419hfWIBE8X45wFH7MpDF0r1Xg74DgTaE3eQ2L0K-k,1816
-nucliadb_utils-2.8.5.post257.dist-info/WHEEL,sha256=pkctZYzUS4AYVn6dJ-7367OJZivF2e8RA9b_ZBjif18,92
-nucliadb_utils-2.8.5.post257.dist-info/top_level.txt,sha256=fE3vJtALTfgh7bcAWcNhcfXkNPp_eVVpbKK-2IYua3E,15
-nucliadb_utils-2.8.5.post257.dist-info/zip-safe,sha256=AbpHGcgLb-kRsJGnwFEktk7uzpZOCcBY74-YBdrKVGs,1
-nucliadb_utils-2.8.5.post257.dist-info/RECORD,,
+nucliadb_utils-2.9.0.post258.dist-info/METADATA,sha256=Nag6DT3S10KN7ik7crE88RXOLPh-GQI2rPYsntr1tRo,1816
+nucliadb_utils-2.9.0.post258.dist-info/WHEEL,sha256=pkctZYzUS4AYVn6dJ-7367OJZivF2e8RA9b_ZBjif18,92
+nucliadb_utils-2.9.0.post258.dist-info/top_level.txt,sha256=fE3vJtALTfgh7bcAWcNhcfXkNPp_eVVpbKK-2IYua3E,15
+nucliadb_utils-2.9.0.post258.dist-info/zip-safe,sha256=AbpHGcgLb-kRsJGnwFEktk7uzpZOCcBY74-YBdrKVGs,1
+nucliadb_utils-2.9.0.post258.dist-info/RECORD,,
```

